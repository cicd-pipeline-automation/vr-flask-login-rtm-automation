#!/usr/bin/env python3
import os
import argparse
import requests
import json
import time


def parse_args():
    p = argparse.ArgumentParser(description="Upload test results to RTM")
    p.add_argument("--archive", required=True, help="ZIP file with test results")
    p.add_argument("--rtm-base", required=True, help="RTM base URL")
    p.add_argument("--project", required=True, help="RTM Project Key")
    p.add_argument("--job-url", required=True, help="Jenkins BUILD_URL")

    # NEW: Test Execution Folder support
    p.add_argument("--folder-id", required=False, help="RTM/Jira Test Execution Folder ID (customfield_10075)")

    return p.parse_args()


def main():
    args = parse_args()

    token = os.getenv("RTM_API_TOKEN")
    if not token:
        raise SystemExit("‚ùå Missing RTM_API_TOKEN environment variable")

    if not args.job_url.startswith(("http://", "https://")):
        raise SystemExit("‚ùå job-url must start with http:// or https://")

    url = f"{args.rtm_base}/api/v2/automation/import-test-results"
    headers = {"Authorization": f"Bearer {token}"}

    # ===============================================
    # Jira fields required by your Jira configuration
    # ===============================================
    jira_description = (
        "Automated Test Execution created via Jenkins pipeline.\n"
        f"Build URL: {args.job_url}\n"
        "This execution was auto-generated by CI/CD."
    )

    jira_acceptance_criteria = (
        "Automated Acceptance Criteria satisfied through Jenkins + RTM integration."
    )

    # ------------------------------------------------
    # Add optional folder ID (customfield_10075)
    # Only include it when provided
    # ------------------------------------------------
    jira_fields = {
        "description": jira_description,
        "customfield_10088": jira_acceptance_criteria
    }

    if args.folder_id:
        jira_fields["customfield_10075"] = args.folder_id  # Test Execution Folder

    metadata_json = json.dumps({"fields": jira_fields})

    print("üöÄ Uploading ZIP to RTM...")

    with open(args.archive, "rb") as f:
        files = {"file": f}
        data = {
            "projectKey": args.project,
            "reportType": "JUNIT",
            "jobUrl": args.job_url,
            "metadata": metadata_json
        }

        response = requests.post(url, headers=headers, files=files, data=data)

    if response.status_code not in (200, 202):
        print("‚ùå RTM Upload Failed")
        print("Status:", response.status_code)
        print("Response:", response.text)
        return

    task_id = response.text.strip()
    print(f"üìå RTM Task ID: {task_id}")

    # Poll import status
    status_url = f"{args.rtm_base}/api/v2/automation/import-status/{task_id}"

    while True:
        resp = requests.get(status_url, headers=headers)
        data = resp.json()

        print(f"‚û°Ô∏è RTM Status: {data.get('status')} (Progress: {data.get('progress')}%)")

        if data.get("status") != "IMPORTING":
            break
        time.sleep(2)

    print("üéâ Import complete:", json.dumps(data, indent=2))

    # Save execution key if valid
    test_exec = data.get("testExecutionKey")
    if not test_exec:
        print("‚ö† Jira Test Execution Key missing ‚Äî creation failed in Jira.")
        return

    with open("rtm_execution_key.txt", "w") as f:
        f.write(test_exec)

    print(f"üìù Saved Test Execution Key ‚Üí rtm_execution_key.txt ({test_exec})")


if __name__ == "__main__":
    main()
